{% extends 'master.html' %}
{% load static %}

{% block title %}Edit {{ blog.title }} - ModernBlog{% endblock %}

{% block meta_description %}Edit and update your blog post on ModernBlog.{% endblock %}

{% block content %}
<!-- Edit Post Header -->
<section class="edit-header py-4 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="display-5 fw-bold mb-3">Edit Post</h1>
                <p class="lead text-muted">Update your content and republish</p>
            </div>
        </div>
    </div>
</section>

<!-- Edit Post Form -->
<section class="edit-form py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="edit-form-container">
                    <form method="post" enctype="multipart/form-data" id="blog-edit-form">
                        {% csrf_token %}
                        
                        <!-- Form Progress -->
                        <div class="form-progress mb-4">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="form-progress"></div>
                            </div>
                            <small class="text-muted">Complete all required fields to update</small>
                        </div>

                        <!-- Post Status Info -->
                        <div class="post-status-info mb-4 p-3 bg-light rounded">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h6 class="mb-1 fw-bold">Current Status</h6>
                                    <span class="badge bg-{% if blog.status == 'published' %}success{% elif blog.status == 'draft' %}warning{% else %}secondary{% endif %}">
                                        {{ blog.get_status_display }}
                                    </span>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <small class="text-muted">
                                        Last updated: {{ blog.updated_at|date:"M d, Y H:i" }}
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Basic Information -->
                        <div class="form-section mb-5">
                            <h3 class="section-title mb-4">
                                <i class="fas fa-edit me-2"></i>Basic Information
                            </h3>
                            
                            <!-- Title -->
                            <div class="mb-4">
                                <label for="{{ form.title.id_for_label }}" class="form-label fw-bold">
                                    {{ form.title.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.title.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">{{ form.title.help_text }}</div>
                            </div>

                            <!-- Category and Status -->
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <label for="{{ form.category.id_for_label }}" class="form-label fw-bold">
                                        {{ form.category.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.category }}
                                    {% if form.category.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.category.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">{{ form.category.help_text }}</div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <label for="{{ form.status.id_for_label }}" class="form-label fw-bold">
                                        {{ form.status.label }}
                                    </label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.status.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">{{ form.status.help_text }}</div>
                                </div>
                            </div>

                            <!-- Excerpt -->
                            <div class="mb-4">
                                <label for="{{ form.excerpt.id_for_label }}" class="form-label fw-bold">
                                    {{ form.excerpt.label }}
                                </label>
                                {{ form.excerpt }}
                                {% if form.excerpt.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.excerpt.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">{{ form.excerpt.help_text }}</div>
                            </div>
                        </div>

                        <!-- Content Editor -->
                        <div class="form-section mb-5">
                            <h3 class="section-title mb-4">
                                <i class="fas fa-file-alt me-2"></i>Content
                            </h3>
                            
                            <!-- Featured Image -->
                            <div class="mb-4">
                                <label for="{{ form.img.id_for_label }}" class="form-label fw-bold">
                                    {{ form.img.label }}
                                </label>
                                <div class="image-upload-container">
                                    {{ form.img }}
                                    {% if blog.img %}
                                    <div class="current-image mt-3">
                                        <h6 class="mb-2">Current Image:</h6>
                                        <img src="{{ blog.img.url }}" alt="{{ blog.title }}" class="img-fluid rounded" style="max-height: 200px;">
                                    </div>
                                    {% endif %}
                                    <div class="image-preview mt-3" id="image-preview" style="display: none;">
                                        <h6 class="mb-2">New Image Preview:</h6>
                                        <img src="" alt="Preview" class="img-fluid rounded" style="max-height: 200px;">
                                    </div>
                                </div>
                                {% if form.img.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.img.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">{{ form.img.help_text }}</div>
                            </div>

                            <!-- Content Editor -->
                            <div class="mb-4">
                                <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">
                                    {{ form.description.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="editor-container">
                                    {{ form.description }}
                                    <div class="editor-toolbar">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-secondary" data-action="bold">
                                                <i class="fas fa-bold"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" data-action="italic">
                                                <i class="fas fa-italic"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" data-action="link">
                                                <i class="fas fa-link"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" data-action="quote">
                                                <i class="fas fa-quote-left"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted ms-3">
                                            <span id="word-count">0</span> words • 
                                            <span id="reading-time">0</span> min read
                                        </small>
                                    </div>
                                </div>
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.description.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">{{ form.description.help_text }}</div>
                            </div>
                        </div>

                        <!-- Organization -->
                        <div class="form-section mb-5">
                            <h3 class="section-title mb-4">
                                <i class="fas fa-tags me-2"></i>Organization
                            </h3>
                            
                            <!-- Tags -->
                            <div class="mb-4">
                                <label for="{{ form.tags.id_for_label }}" class="form-label fw-bold">
                                    {{ form.tags.label }}
                                </label>
                                {{ form.tags }}
                                {% if form.tags.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.tags.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">{{ form.tags.help_text }}</div>
                            </div>

                            <!-- Featured Post -->
                            <div class="mb-4">
                                <div class="form-check">
                                    {{ form.featured }}
                                    <label class="form-check-label fw-bold" for="{{ form.featured.id_for_label }}">
                                        {{ form.featured.label }}
                                    </label>
                                </div>
                                <div class="form-text">{{ form.featured.help_text }}</div>
                            </div>
                        </div>

                        <!-- SEO Settings -->
                        <div class="form-section mb-5">
                            <h3 class="section-title mb-4">
                                <i class="fas fa-search me-2"></i>SEO Settings
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-bs-toggle="collapse" data-bs-target="#seo-settings">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </h3>
                            
                            <div class="collapse" id="seo-settings">
                                <div class="mb-4">
                                    <label for="{{ form.meta_description.id_for_label }}" class="form-label fw-bold">
                                        {{ form.meta_description.label }}
                                    </label>
                                    {{ form.meta_description }}
                                    <div class="form-text">{{ form.meta_description.help_text }}</div>
                                    <small class="text-muted">
                                        <span id="meta-desc-count">0</span>/160 characters
                                    </small>
                                </div>

                                <div class="mb-4">
                                    <label for="{{ form.meta_keywords.id_for_label }}" class="form-label fw-bold">
                                        {{ form.meta_keywords.label }}
                                    </label>
                                    {{ form.meta_keywords }}
                                    <div class="form-text">{{ form.meta_keywords.help_text }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions d-flex justify-content-between align-items-center">
                            <div class="draft-actions">
                                <a href="{% url 'blog:detail' blog.slug %}" class="btn btn-outline-secondary me-3">
                                    <i class="fas fa-eye me-2"></i>Preview
                                </a>
                                <button type="button" class="btn btn-outline-warning" id="save-draft">
                                    <i class="fas fa-save me-2"></i>Save Draft
                                </button>
                            </div>
                            <div class="publish-actions">
                                <a href="{% url 'blog:list' %}" class="btn btn-outline-secondary me-3">Cancel</a>
                                <button type="submit" class="btn btn-dark btn-lg">
                                    <i class="fas fa-sync me-2"></i>Update Post
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
.edit-header {
    background: linear-gradient(135deg, var(--gray-100), #ffffff);
}

.edit-form-container {
    background-color: var(--background-primary);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.section-title {
    color: var(--text-primary);
    font-size: 1.25rem;
    border-bottom: 2px solid var(--accent-color);
    padding-bottom: 0.5rem;
}

.form-progress {
    background-color: var(--gray-50);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.post-status-info {
    border: 1px solid var(--border-color);
}

.editor-container {
    position: relative;
}

.editor-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem;
    background-color: var(--gray-50);
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 8px 8px;
}

.image-upload-container {
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s ease;
}

.image-upload-container:hover {
    border-color: var(--accent-color);
    background-color: var(--gray-50);
}

.current-image img,
.image-preview img {
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.form-actions {
    background-color: var(--gray-50);
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.form-check-input:checked {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}

.form-control:focus,
.form-select:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 0.2rem rgba(var(--accent-color-rgb), 0.25);
}

@media (max-width: 768px) {
    .edit-form-container {
        padding: 1rem;
    }
    
    .form-actions {
        flex-direction: column;
        gap: 1rem;
    }
    
    .publish-actions {
        width: 100%;
        text-align: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form progress tracking
    const form = document.getElementById('blog-edit-form');
    const progressBar = document.getElementById('form-progress');
    const requiredFields = ['title', 'category', 'description'];
    
    function updateProgress() {
        let completed = 0;
        requiredFields.forEach(fieldName => {
            const field = document.getElementById(`id_${fieldName}`);
            if (field && field.value.trim()) {
                completed++;
            }
        });
        const progress = (completed / requiredFields.length) * 100;
        progressBar.style.width = progress + '%';
    }
    
    // Update progress on field changes
    requiredFields.forEach(fieldName => {
        const field = document.getElementById(`id_${fieldName}`);
        if (field) {
            field.addEventListener('input', updateProgress);
        }
    });
    
    // Initial progress update
    updateProgress();
    
    // Image preview
    const imageInput = document.getElementById('id_img');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = imagePreview.querySelector('img');
    
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            imagePreview.style.display = 'none';
        }
    });
    
    // Word count and reading time
    const contentField = document.getElementById('id_description');
    const wordCountSpan = document.getElementById('word-count');
    const readingTimeSpan = document.getElementById('reading-time');
    
    function updateWordCount() {
        const text = contentField.value;
        const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
        const readingTime = Math.max(1, Math.round(wordCount / 200));
        
        wordCountSpan.textContent = wordCount;
        readingTimeSpan.textContent = readingTime;
    }
    
    contentField.addEventListener('input', updateWordCount);
    
    // Initial word count update
    updateWordCount();
    
    // Meta description character count
    const metaDescField = document.getElementById('id_meta_description');
    const metaDescCount = document.getElementById('meta-desc-count');
    
    metaDescField.addEventListener('input', function() {
        metaDescCount.textContent = this.value.length;
    });
    
    // Initial meta description count
    metaDescCount.textContent = metaDescField.value.length;
    
    // Save draft button
    document.getElementById('save-draft').addEventListener('click', function() {
        const statusField = document.getElementById('id_status');
        statusField.value = 'draft';
        form.submit();
    });
    
    // Auto-save functionality
    let autoSaveTimeout;
    function autoSave() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            // Save form data to localStorage
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            localStorage.setItem('blog_edit_draft', JSON.stringify(data));
        }, 2000);
    }
    
    // Auto-save on form changes
    form.addEventListener('input', autoSave);
    
    // Clear draft on successful submit
    form.addEventListener('submit', function() {
        localStorage.removeItem('blog_edit_draft');
    });
});
</script>
{% endblock %}
